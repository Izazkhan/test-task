<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPA - Categories & Courses</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="page-title">
        <h2>Course Catalog</h2>
    </div>
    <div class="container">
        <div class="sidebar">
            <h3>Categories</h3>
            <ul id="myUL"></ul>
        </div>
        <div id="content">
            <div id="courses">No category selected</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let activeCategory = null; // Track the currently active category element
            async function fetchInitialData() {
                try {
                    let response = await fetch('http://api.cc.localhost/all-categories-and-courses');
                    let data = await response.json();
                    renderCategories(data.categories);
                    initialCourses = data.courses; // Store all courses
                    renderCourses(initialCourses); // Display all courses initially
                } catch (error) {
                    console.error('Error fetching initial data:', error);
                    renderCategories([]);
                    renderCourses([]);
                }
            }
            async function fetchCategories() {
                try {
                    let response = await fetch('http://api.cc.localhost/categories');
                    let categories = await response.json();
                    renderCategories(categories);
                } catch (error) {
                    console.error('Error fetching categories:', error);
                }
            }

            function renderCategories(categories, parentId = null, container = document.getElementById('myUL')) {
                let filteredCategories = categories.filter(cat => cat.parent_id === parentId);

                filteredCategories.forEach(category => {
                    let li = document.createElement('li');

                    let span = document.createElement('span');
                    span.classList.add('caret');
                    span.textContent = `${category.category_name} (${category.count_of_courses})`;
                    span.dataset.categoryId = category.category_id; // Store category ID for reference
                    span.onclick = () => fetchCourses(category.category_id, span);

                    li.appendChild(span);

                    let subList = document.createElement('ul');
                    subList.classList.add('nested');
                    li.appendChild(subList);

                    container.appendChild(li);
                    renderCategories(categories, category.category_id, subList);

                    // Add toggle functionality
                    span.addEventListener("click", function () {
                        this.parentElement.querySelector(".nested").classList.toggle("active");
                    });
                });
            }

            async function fetchCourses(categoryId, element) {
                try {
                    if (activeCategory == element) {
                        return;
                    }

                    // Remove active class from previous selection
                    if (activeCategory && activeCategory !== element) {
                        activeCategory.classList.remove('active');
                    }
                    // Add active class to the clicked element
                    element.classList.add('active');
                    activeCategory = element; // Update the active category

                    let response = await fetch(`http://api.cc.localhost/categories/${categoryId}/courses`);
                    let courses = await response.json();
                    renderCourses(courses);
                } catch (error) {
                    console.error('Error fetching courses:', error);
                }
            }

            function renderCourses(courses) {
                let coursesContainer = document.getElementById('courses');
                coursesContainer.innerHTML = ''; // Clear previous courses

                if (!courses || courses.length === 0) {
                    let noCoursesElement = document.createElement('div');
                    noCoursesElement.classList.add('no-courses');
                    noCoursesElement.textContent = 'No courses found';
                    coursesContainer.appendChild(noCoursesElement);
                } else {
                    courses.forEach(course => {
                        let courseElement = document.createElement('div');
                        courseElement.classList.add('course');
                        courseElement.innerHTML = `
                            <img src="${course.preview}" alt="${course.name}">
                            <div class="cnt">
                                <h4 class="heading">${course.name}</h4>
                                <div class="description">${course.description}</div>
                                <div class="tag">${course.main_category_name}</div>
                            </div>
                        `;
                        coursesContainer.appendChild(courseElement);
                    });
                }
            }

            // fetchCategories();
            fetchInitialData();
        });
    </script>
</body>

</html>